<div class="register-page">
  
  <div class="logo-container text-center mb-4">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2 d-inline-block align-middle" aria-hidden="true">
      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#1D82A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M2 17L12 22L22 17" stroke="#1D82A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M2 12L12 17L22 12" stroke="#1D82A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div class="logo-text-container">
        <div class="logo-brand-overline">Centro M√©dico</div>
        <div class="logo-brand-title">Huerta Robles</div>
    </div>
  </div>

  <div class="register-card shadow-sm">
    <h2 class="card-title mb-1">Crear una cuenta</h2>
    <p class="card-subtitle text-muted mb-4">Sigue los pasos para completar tu registro.</p>

    <div class="stepper-container mb-5">
      <ng-container *ngFor="let step of [1,2,3,4,5]; let i = index">
          <div class="step" [class.active]="currentStep >= step">
            <div class="step-circle">{{ step }}</div>
          </div>
          <div class="step-line" [class.active]="currentStep > step" *ngIf="step < 5"></div>
      </ng-container>
    </div>
    
    <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
      
      <div *ngIf="currentStep === 1">
        
        <div class="mb-3 text-start">
          <label for="tipoDocumento" class="form-label custom-label">Tipo de Documento</label>
          <select 
            id="tipoDocumento" 
            class="form-select custom-input" 
            formControlName="tipoDocumento">
            <option *ngFor="let doc of tiposDocumento" [value]="doc.value">
              {{ doc.name }}
            </option>
          </select>
        </div>

        <div class="mb-3 text-start">
          <label for="numeroDocumento" class="form-label custom-label" 
                 [class.text-danger]="registerForm.get('numeroDocumento')?.invalid && (registerForm.get('numeroDocumento')?.dirty || registerForm.get('numeroDocumento')?.touched)">
            N√∫mero de Documento
          </label>
          <input 
            type="text" 
            id="numeroDocumento"
            class="form-control custom-input" 
            formControlName="numeroDocumento" 
            placeholder="Ingrese el n√∫mero"
            [maxlength]="currentDocConfig?.length || 20" 
            (input)="onDocumentInput($event)"
            [class.is-invalid]="registerForm.get('numeroDocumento')?.invalid && (registerForm.get('numeroDocumento')?.dirty || registerForm.get('numeroDocumento')?.touched)">
          
          <div class="invalid-feedback d-block small mt-1" 
               *ngIf="registerForm.get('numeroDocumento')?.invalid && (registerForm.get('numeroDocumento')?.dirty || registerForm.get('numeroDocumento')?.touched)">
             <span *ngIf="registerForm.get('numeroDocumento')?.errors?.['required']">El n√∫mero es obligatorio.</span>
             <span *ngIf="registerForm.get('numeroDocumento')?.errors?.['pattern'] || registerForm.get('numeroDocumento')?.errors?.['minlength']">
               <ng-container *ngIf="currentDocConfig?.value === 'DNI'">Debe tener 8 d√≠gitos.</ng-container>
               <ng-container *ngIf="currentDocConfig?.value === 'CE'">Debe tener 12 d√≠gitos.</ng-container>
               <ng-container *ngIf="currentDocConfig?.value === 'PASAPORTE'">Debe tener entre 6 y 20 caracteres.</ng-container>
             </span>
          </div>
        </div>
      </div>

      <div *ngIf="currentStep === 2">
        <div class="row">
            
            <div class="col-12 mb-3 text-start">
                <label for="nombres" class="form-label custom-label">Nombres</label>
                <input 
                  type="text" 
                  id="nombres" 
                  class="form-control custom-input" 
                  formControlName="nombres" 
                  placeholder=""
                  (input)="checkNameSpaces($event)"
                  [class.is-invalid]="registerForm.get('nombres')?.invalid && (registerForm.get('nombres')?.dirty || registerForm.get('nombres')?.touched)">
                
                <div class="invalid-feedback" *ngIf="registerForm.get('nombres')?.hasError('pattern')">
                  Solo letras permitidas.
                </div>
            </div>

            <div class="col-md-6 mb-3 text-start">
                <label for="apellidoPaterno" class="form-label custom-label">Apellido Paterno</label>
                <input 
                  type="text" 
                  id="apellidoPaterno" 
                  class="form-control custom-input" 
                  formControlName="apellidoPaterno" 
                  placeholder=""
                  (input)="toUpperCase($event)"
                  [class.is-invalid]="registerForm.get('apellidoPaterno')?.invalid && (registerForm.get('apellidoPaterno')?.dirty || registerForm.get('apellidoPaterno')?.touched)">
                
                <div class="invalid-feedback">Sin espacios.</div>
            </div>

            <div class="col-md-6 mb-3 text-start">
                <label for="apellidoMaterno" class="form-label custom-label">Apellido Materno</label>
                <input 
                  type="text" 
                  id="apellidoMaterno" 
                  class="form-control custom-input" 
                  formControlName="apellidoMaterno" 
                  placeholder=""
                  (input)="toUpperCase($event)"
                  [class.is-invalid]="registerForm.get('apellidoMaterno')?.invalid && (registerForm.get('apellidoMaterno')?.dirty || registerForm.get('apellidoMaterno')?.touched)">
            </div>

            <div class="col-md-6 mb-3 text-start">
                <label for="fechaNacimiento" class="form-label custom-label">Fecha Nacimiento</label>
                <input 
                  type="date" 
                  id="fechaNacimiento" 
                  class="form-control custom-input date-input" 
                  formControlName="fechaNacimiento" 
                  [max]="maxDate">
            </div>

            <div class="col-md-6 mb-3 text-start">
                <label for="genero" class="form-label custom-label">G√©nero</label>
                <select id="genero" class="form-select custom-input" formControlName="genero">
                    <option value="" disabled selected>SELECCIONE</option>
                    
                    <option *ngFor="let g of generos" [value]="g">
                        {{ formatGender(g) }}
                    </option>
                    
                </select>
            </div>
        </div>
      </div>

      <div *ngIf="currentStep === 3">
          
          <div class="mb-3 text-start">
              <label for="telefonoMovil" class="form-label custom-label">Celular</label>
              <div class="input-group">
                  <button class="btn btn-outline-secondary dropdown-toggle bg-white border-end-0 text-muted" type="button" data-bs-toggle="dropdown" aria-label="Seleccionar prefijo pa√≠s">
                    {{ selectedPrefix }}
                  </button>
                  <ul class="dropdown-menu">
                    <li *ngFor="let p of prefijos">
                        <a class="dropdown-item" href="javascript:void(0)" (click)="selectedPrefix = p.code">
                            {{ p.flag }} {{ p.code }} ({{ p.country }})
                        </a>
                    </li>
                  </ul>
                  <input 
                    type="text" 
                    id="telefonoMovil" 
                    class="form-control custom-input border-start-0 ps-0" 
                    formControlName="telefonoMovil" 
                    placeholder="" 
                    maxlength="9" 
                    (input)="onPhoneInput($event)"
                    [class.is-invalid]="registerForm.get('telefonoMovil')?.invalid && (registerForm.get('telefonoMovil')?.dirty || registerForm.get('telefonoMovil')?.touched)">
              </div>
              <div class="invalid-feedback d-block small mt-1" *ngIf="registerForm.get('telefonoMovil')?.errors?.['pattern']">
                Debe ser un n√∫mero v√°lido (inicia con 9, tiene 9 d√≠gitos).
              </div>
          </div>

          <div class="mb-3 text-start">
              <label for="emailReg" class="form-label custom-label">Email</label>
              <input 
                type="email" 
                id="emailReg" 
                class="form-control custom-input text-lowercase" 
                formControlName="email" 
                placeholder="ejemplo@correo.com">
              
              <div class="invalid-feedback d-block small" *ngIf="registerForm.get('email')?.hasError('pattern') && registerForm.get('email')?.touched">
                Formato inv√°lido (ej: nombre@dominio.com).
              </div>
          </div>

          <div class="mb-3 text-start">
              <label for="passwordReg" class="form-label custom-label">Contrase√±a</label>
              
              <div class="input-group">
                  <input 
                    [type]="showPassword ? 'text' : 'password'" 
                    id="passwordReg" 
                    class="form-control custom-input border-end-0" 
                    formControlName="password" 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                  
                  <button 
                    class="btn btn-outline-secondary border-start-0 bg-white" 
                    type="button" 
                    (click)="togglePasswordVisibility()"
                    [attr.aria-label]="showPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'">
                      <i class="bi" [ngClass]="showPassword ? 'bi-eye-slash-fill' : 'bi-eye-fill'" aria-hidden="true"></i>
                  </button>
              </div>

              <div class="password-requirements mt-2 p-2 rounded bg-light">
                  <p class="mb-1 small fw-bold text-muted">Requisitos:</p>
                  
                  <div class="req-item" [class.valid]="registerForm.get('password')?.value?.length >= 8">
                      <i class="bi" [ngClass]="registerForm.get('password')?.value?.length >= 8 ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'"></i>
                      <span>M√≠nimo 8 caracteres</span>
                  </div>

                  <div class="req-item" [class.valid]="passwordCriteria.hasNumber">
                      <i class="bi" [ngClass]="passwordCriteria.hasNumber ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'"></i>
                      <span>1 n√∫mero</span>
                  </div>
                  
                  <div class="req-item" [class.valid]="passwordCriteria.hasUpper">
                      <i class="bi" [ngClass]="passwordCriteria.hasUpper ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'"></i>
                      <span>1 may√∫scula</span>
                  </div>
                  
                  <div class="req-item" [class.valid]="passwordCriteria.hasSpecial">
                      <i class="bi" [ngClass]="passwordCriteria.hasSpecial ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'"></i>
                      <span>1 car√°cter especial (@$%&)</span>
                  </div>
              </div>
          </div>

          <div class="mb-3 text-start">
              <label for="confirmPassword" class="form-label custom-label">Confirmar Contrase√±a</label>
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                id="confirmPassword" 
                class="form-control custom-input" 
                formControlName="confirmPassword" 
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>

          <div class="mb-2 form-check text-start">
            <input type="checkbox" id="acceptTerms" class="form-check-input" formControlName="acceptTerms">
            <label for="acceptTerms" class="form-check-label small user-select-none">
                He le√≠do y acepto los <a href="javascript:void(0)" class="link-styled fw-bold" (click)="openTerms()">T√©rminos y Condiciones</a>.
            </label>
          </div>
          
          <div class="mb-3 form-check text-start">
            <input type="checkbox" id="acceptConsent" class="form-check-input" formControlName="acceptConsent">
            <label for="acceptConsent" class="form-check-label small user-select-none">
                Acepto el <a href="javascript:void(0)" class="link-styled fw-bold" (click)="openConsent()">Consentimiento de datos</a>.
            </label>
          </div>
      </div>

      <div *ngIf="currentStep === 4">
        
        <div class="mb-3 text-start">
            <label for="departamento" class="form-label custom-label">Departamento</label>
            <select id="departamento" class="form-select custom-input" formControlName="departamento">
                <option value="">Seleccione</option>
                <option *ngFor="let dep of departamentos" [value]="dep">{{ dep }}</option>
            </select>
        </div>
        
        <div class="mb-3 text-start">
            <label for="provincia" class="form-label custom-label">Provincia</label>
            <select id="provincia" class="form-select custom-input" formControlName="provincia" [disabled]="!provincias.length">
                <option value="">Seleccione</option>
                <option *ngFor="let prov of provincias" [value]="prov">{{ prov }}</option>
            </select>
        </div>
        
        <div class="mb-3 text-start">
            <label for="distrito" class="form-label custom-label">Distrito</label>
            <select id="distrito" class="form-select custom-input" formControlName="distrito" [disabled]="!distritos.length">
                <option value="">Seleccione</option>
                <option *ngFor="let dist of distritos" [value]="dist">{{ dist }}</option>
            </select>
        </div>
        
        <div class="mb-3 text-start">
            <label for="direccion" class="form-label custom-label">Direcci√≥n</label>
            <input 
              type="text" 
              id="direccion" 
              class="form-control custom-input" 
              formControlName="direccion" 
              placeholder="Ej. Av. Arequipa 123, Dpto 201" 
              (input)="toUpperCase($event)"
              [class.is-invalid]="registerForm.get('direccion')?.invalid && (registerForm.get('direccion')?.dirty || registerForm.get('direccion')?.touched)">
            
            <div class="invalid-feedback d-block small mt-1" *ngIf="registerForm.get('direccion')?.hasError('pattern') && registerForm.get('direccion')?.touched">
                No use caracteres especiales (solo letras, n√∫meros, #, -, .).
            </div>
            <div class="invalid-feedback d-block small mt-1" *ngIf="registerForm.get('direccion')?.hasError('required') && registerForm.get('direccion')?.touched">
                La direcci√≥n es obligatoria.
            </div>
        </div>
      </div>

      <div *ngIf="currentStep === 5">
        <div class="verification-box p-3 mb-4">
            <div class="d-flex align-items-start">
                <div class="me-2 mt-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </div>
                <div>
                    <h6 class="mb-1 fw-bold text-dark">Verificaci√≥n Requerida</h6>
                    <p class="mb-0 small text-muted">C√≥digo enviado: <strong>123456</strong></p>
                </div>
            </div>
        </div>
        
        <div class="mb-3 text-start">
            <label for="verificationCode" class="form-label custom-label">C√≥digo de Verificaci√≥n</label>
            <input 
              type="text" 
              id="verificationCode" 
              class="form-control custom-input text-center letter-spacing-2" 
              formControlName="verificationCode" 
              maxlength="6" 
              [class.is-invalid]="errorMessage && currentStep === 5">
        </div>
      </div>

      <div *ngIf="errorMessage" class="alert alert-danger p-2 small mt-3 text-center">
          {{ errorMessage }}
      </div>
      <div *ngIf="successMessage" class="alert alert-success p-2 small mt-3 text-center">
          {{ successMessage }}
      </div>

      <div class="d-flex justify-content-between align-items-center mt-5 action-buttons">
        
        <button type="button" class="btn btn-light border btn-back" (click)="prevStep()" *ngIf="currentStep > 1" title="Volver al paso anterior">
            ‚Üê Atr√°s
        </button>
        
        <div *ngIf="currentStep === 1"></div>
        
        <button type="button" class="btn btn-primary btn-next text-white" (click)="nextStep()" *ngIf="currentStep < 5" title="Ir al siguiente paso">
            Siguiente ‚Üí
        </button>
        
        <button type="submit" class="btn btn-primary btn-next text-white" *ngIf="currentStep === 5" [disabled]="isLoading" title="Completar registro">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span> 
            {{ isLoading ? 'Registrando...' : 'Finalizar Registro' }}
        </button>
      </div>
      
      <div class="text-center mt-4">
        <a routerLink="/login" class="link-styled small">¬øYa tienes una cuenta? Inicia Sesi√≥n</a>
      </div>
    </form> 
  </div>
</div>

<div class="custom-modal-overlay" *ngIf="showTermsModal">
    <div class="custom-modal">
        <div class="modal-header">
            <h5>üìú T√©rminos y Condiciones</h5>
            <button type="button" class="btn-close" (click)="closeTerms()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body-scroll">
            <p><strong>1. Uso del Servicio:</strong> Al utilizar este sistema de citas, usted acepta...</p>
            <p><strong>2. Privacidad:</strong> Sus datos ser√°n tratados con confidencialidad...</p>
            <p><strong>3. Responsabilidad:</strong> El usuario es responsable de la veracidad de los datos...</p>
            </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" (click)="acceptTerms()">He le√≠do y Acepto</button>
        </div>
    </div>
</div>

<div class="custom-modal-overlay" *ngIf="showConsentModal">
    <div class="custom-modal">
        <div class="modal-header">
            <h5>üõ°Ô∏è Consentimiento de Datos</h5>
            <button type="button" class="btn-close" (click)="closeConsent()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body-scroll">
            <p>Autorizo al Centro M√©dico Huerta Robles a tratar mis datos personales para fines de gesti√≥n de citas y comunicaci√≥n m√©dica.</p>
            <p>Entiendo que puedo revocar este consentimiento en cualquier momento.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" (click)="acceptConsent()">Acepto el tratamiento</button>
        </div>
    </div>
</div>